name: Daily Git Commit Report

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  workflow_dispatch:

jobs:
  daily-git-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (dummy)
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set yesterday date
        id: date
        run: echo "date=$(TZ=Asia/Shanghai date -d yesterday '+%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Collect commits and generate report
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          MY_GITHUB_USERNAME: ${{ secrets.MY_GITHUB_USERNAME }}
        run: |
          DATE=${{ steps.date.outputs.date }}
          echo "## ğŸ—“ï¸ ${DATE} Git æäº¤æ—¥æŠ¥" > report.md
          echo "" >> report.md

          found=false
          declare -A repo_commit_count

          repos=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/user/repos?affiliation=owner,collaborator,organization_member&per_page=100" | jq -r '.[].full_name')

          for repo in $repos; do
            branches=$(curl -s -H "Authorization: token $GH_TOKEN" "https://api.github.com/repos/$repo/branches" | jq -r '.[].name')

            for branch in $branches; do
              commits=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$repo/commits?sha=$branch&since=${DATE}T00:00:00+08:00&until=${DATE}T23:59:59+08:00" | \
                jq -r --arg login "$MY_GITHUB_USERNAME" '
                  .[] | select(.author.login == $login) |
                  "- \(.commit.message) by \(.commit.author.name) (\(.sha[0:7]))" +
                  (if .verification.verified then " âœ…[GPGç­¾å]" else "" end)
                ')

              if [ -n "$commits" ]; then
                found=true

                # ç´¯è®¡ä»“åº“æäº¤æ¬¡æ•°
                count=$(echo "$commits" | wc -l)
                repo_commit_count["$repo"]=$(( ${repo_commit_count["$repo"]:-0} + count ))

                echo "ğŸ“ ä»“åº“ï¼š$repoï¼ˆåˆ†æ”¯ï¼š$branchï¼‰" >> report.md
                echo "$commits" >> report.md
                echo "" >> report.md
              fi
            done
          done

          if [ "$found" = true ]; then
            echo "ğŸ“Š æäº¤ç»Ÿè®¡ï¼ˆæŒ‰ä»“åº“ï¼‰ï¼š" > summary.md
            for repo in "${!repo_commit_count[@]}"; do
              echo "- $repo: ${repo_commit_count[$repo]} æ¬¡æäº¤" >> summary.md
            done
            echo "" >> summary.md
            cat summary.md report.md > final-report.md
          else
            echo "- ï¼ˆæ— æœ¬äººæäº¤è®°å½•ï¼‰" > final-report.md
          fi

          cat final-report.md

      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SMTP_HOST }}
          server_port: ${{ secrets.MAIL_SMTP_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Bot <${{ secrets.MAIL_USERNAME }}>
          subject: 'æ¯æ—¥ Git æäº¤æ—¥æŠ¥ - ${{ steps.date.outputs.date }}'
          body: file://final-report.md
